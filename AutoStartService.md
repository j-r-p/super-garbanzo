# Super Garbanzo Server Configuration

This document outlines the setup for persistent startup scripts and automated SSL certificate renewal on the Ubuntu EC2 instance.

**Environment:** Ubuntu (EC2) with Docker installed via Snap.
**Project Path:** `/home/ubuntu/super-garbanzo/16`

---

## 1. The Startup Script (`startup.sh`)

This script handles the logic of bringing up the Docker containers. It includes a critical "wait loop" to ensure the Docker daemon is fully responsive before sending commands.

**File Path:** `/home/ubuntu/super-garbanzo/16/startup.sh`

### Script Content
Create or update the file with this content:

```bash
#!/bin/bash

# 1. Navigate to the script's directory first (Fixes relative path issues)
cd "$(dirname "$0")"

# 2. Wait for Docker Daemon to be ready
# (Prevents "Cannot connect to Docker daemon" errors on reboot)
echo "Waiting for Docker daemon to be ready..."
until /snap/bin/docker info > /dev/null 2>&1; do
  echo "Docker not ready yet... sleeping 2s"
  sleep 2
done

echo "Docker is UP! Starting containers..."
whoami
echo "Running in: $(pwd)"

# 3. Run containers (Using explicit Snap path and 'compose' command)
/snap/bin/docker compose -f docker-compose.yml up -d

# BCUSA
/snap/bin/docker compose -f bcusa/docker-compose.yml up -d

# DPUSA
/snap/bin/docker compose -f dpusa/docker-compose.yml up -d

```

**Make it executable:**

```bash
chmod +x /home/ubuntu/super-garbanzo/16/startup.sh

```

---

## 2. Auto-Start Service (Systemd)

We use a Systemd service to run the script above automatically on boot. It is configured to handle Snap environment variables and logging.

**File Path:** `/etc/systemd/system/super-garbanzo.service`

### Service Configuration

Create this file using `sudo nano /etc/systemd/system/super-garbanzo.service`:

```ini
[Unit]
Description=Super Garbanzo Startup Script
# Wait for Network and Snap Docker Service
After=network-online.target snap.docker.dockerd.service
Wants=network-online.target snap.docker.dockerd.service

[Service]
Type=oneshot
User=root

# CRITICAL: Snap needs to know where HOME is to function
Environment="HOME=/root"
# Ensure Snap binary path is present in the environment
Environment="PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"

# Correct Working Directory
WorkingDirectory=/home/ubuntu/super-garbanzo/16/

# Execute the script and redirect ALL logs to a file for debugging
ExecStart=/bin/bash -c '/home/ubuntu/super-garbanzo/16/startup.sh >> /var/log/super-garbanzo.log 2>&1'

RemainAfterExit=yes
# Safety: If script hangs for >60s, kill it so the server boot completes
TimeoutStartSec=60

[Install]
WantedBy=multi-user.target

```

### Enable the Service

Run these commands to register the service:

```bash
sudo systemctl daemon-reload
sudo systemctl enable super-garbanzo.service

```

**To Debug:**
If the service fails, check the log file generated by the config above:

```bash
cat /var/log/super-garbanzo.log

```

---

## 3. SSL Certificate Renewal (Cron)

We use a system-level cron job to check for expiring certificates daily at **3:00 AM**.

### Setup Command

Run the following block to create the persistent cron file at `/etc/cron.d/certbot-renew`.

```bash
sudo bash -c 'cat << EOF > /etc/cron.d/certbot-renew
# Run at 3am every day
0 3 * * * root cd /home/ubuntu/super-garbanzo/16/proxy && /snap/bin/docker compose run --rm certbot renew --quiet && /snap/bin/docker compose exec proxy nginx -s reload
EOF'

```

### Verification

To verify the job is scheduled correctly:

```bash
cat /etc/cron.d/certbot-renew

```

---

## 4. Disaster Recovery (Instance Repave)

If the EC2 instance is terminated and recreated ("repaved"), the `/etc` files (Systemd and Cron) will be lost.

To restore functionality on a new instance:

1. Clone/Restore the `/home/ubuntu/super-garbanzo` project files.
2. Re-run the **Enable the Service** commands from Section 2.
3. Re-run the **Setup Command** from Section 3.

```

```
